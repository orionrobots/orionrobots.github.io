name: Build, test and deploy

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build_site:
    concurrency:
      group: site_building
      cancel-in-progress: true
    runs-on: ubuntu-latest
    container:
      image: jekyll/builder:4
    steps:
      - uses: actions/checkout@v2
      - name: Setup dependencies
        run: |
          apk add imagemagick
          gem install jekyll-toc rmagick
      - name: build
        run: |
          chown jekyll . -R
          mkdir .jekyll-cache
          jekyll build
      - name: Tarball the size
        run: |
          tar -czf _site.tar.gz _site
      - name: upload site artifact
        uses: actions/upload-artifact@v3
        with: 
          name: _site
          path: _site.tar.gz
          if-no-files-found: error
      - name: upload httpd.conf artifact
        uses: actions/upload-artifact@v3
        with: 
          name: httpd.conf
          path: _drafts/staging/httpd.conf
          if-no-files-found: error

  staging_test:
    concurrency:
      group: site_building
    runs-on: ubuntu-latest
    needs: build_site
    steps:
      - uses: actions/checkout@v2
      - name: Fetch site artifact
        uses: actions/download-artifact@v3
        with:
          name: _site
      - name: extract site artifact
        run: |
          tar -xzf _site.tar.gz
      - name: Prepare for docker build
        run: |
          cp _drafts/staging/Dockerfile _site/
          cp _drafts/staging/http2.conf _site/
          cd _site/
          mv htaccess .htaccess

      - name: Build container
        run: |
          docker build -t orionrobots:latest _site

      - name: Run as service and test
        run: |
          docker run --rm -d -p8080:80 --name orionrobots orionrobots:latest
          # Wait for the service to start
          sleep 10
          curl -I -L -f http://localhost:8080/
          curl -I -L -f http://localhost:8080/construction_guide.html 
          curl -I -L -f http://localhost:8080/wiki/lego
          docker stop orionrobots

  deploy:
    concurrency: live_environment
    runs-on: ubuntu-latest
    needs: staging_test
    steps:
      - name: Fetch site artifact
        uses: actions/download-artifact@v3
        with:
          name: _site
      - name: extract site artifact
        run: |
          tar -xzf _site.tar.gz
      - name: Fetch httpd conf artifact
        uses: actions/download-artifact@v3
        with:
          name: httpd.conf
          path: _drafts/staging/httpd.conf
      # Sync the files
      - name: Install and prepare rsync
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avv
          path: _site/
          remote_path: public_html
          remote_host: home738752777.1and1-data.host
          remote_user: ${{ secrets.ORIONROBOTS_DEPLOY_USER }}
          remote_key: ${{ secrets.ORIONROBOTS_DEPLOY_KEY }}
      - name: Copy over the htaccess file
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avv
          path: _site/htaccess
          remote_path: public_html/.htaccess
          remote_host: home738752777.1and1-data.host
          remote_user: ${{ secrets.ORIONROBOTS_DEPLOY_USER }}
          remote_key: ${{ secrets.ORIONROBOTS_DEPLOY_KEY }}
      # Checks
      - name: Check if the site is up
        run: |
          curl -I -L -f https://orionrobots.co.uk/
          curl -I -L -f https://orionrobots.co.uk/construction_guide.html 
          curl -I -L -f https://orionrobots.co.uk/wiki/lego
      
